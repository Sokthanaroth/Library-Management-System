{% extends "library_app/base.html" %}

{% block title %}Barcode Scanner{% endblock %}

{% block content %}
<style>
@media (max-width: 768px) {
    .container { padding: 0.5rem; }
    .btn-group { flex-direction: column; width: 100%; }
    .btn-group .btn { margin-bottom: 0.25rem; border-radius: 0.375rem !important; }
    .card-body { padding: 1rem; }
    #camera { max-height: 300px; }
    .form-control-lg { font-size: 1rem; padding: 0.5rem; }
    .btn-lg { padding: 0.5rem 1rem; font-size: 1rem; }
}

.barcode-scanner-mobile {
    touch-action: manipulation;
}

.bulk-item {
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.25rem;
    border-radius: 0.25rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.scan-feedback {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    background: rgba(0, 123, 255, 0.9);
    color: white;
    padding: 0.5rem;
    border-radius: 0.25rem;
    text-align: center;
    z-index: 1000;
}
</style>

<div class="container mt-4 barcode-scanner-mobile">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-upc-scan me-2"></i>Barcode Scanner</h2>
                <a href="{% url 'book_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Books
                </a>
            </div>

            <div class="row">
                <!-- Scanner Interface -->
                <div class="col-md-8">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-camera me-1"></i>Scan Barcode</h5>
                        </div>
                        <div class="card-body">
                            <!-- Mode Selection -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Scan Mode:</label>
                                <div class="btn-group w-100 mb-3" role="group" aria-label="Mode selection">
                                    <input type="radio" class="btn-check" name="scan_mode" id="single" value="single" checked>
                                    <label class="btn btn-outline-primary" for="single">
                                        <i class="bi bi-upc-scan me-1"></i>Single Scan
                                    </label>

                                    <input type="radio" class="btn-check" name="scan_mode" id="bulk" value="bulk">
                                    <label class="btn btn-outline-info" for="bulk">
                                        <i class="bi bi-collection me-1"></i>Bulk Scan
                                    </label>
                                </div>

                                <!-- Action Selection (Single Mode) -->
                                <div id="singleActions" class="mb-3">
                                    <label class="form-label fw-bold">Action:</label>
                                    <div class="btn-group w-100" role="group" aria-label="Action selection">
                                        <input type="radio" class="btn-check" name="action" id="search" value="search" checked>
                                        <label class="btn btn-outline-primary" for="search">
                                            <i class="bi bi-search me-1"></i>Search
                                        </label>

                                        <input type="radio" class="btn-check" name="action" id="borrow" value="borrow">
                                        <label class="btn btn-outline-success" for="borrow">
                                            <i class="bi bi-bookmark-plus me-1"></i>Borrow
                                        </label>

                                        <input type="radio" class="btn-check" name="action" id="return" value="return">
                                        <label class="btn btn-outline-warning" for="return">
                                            <i class="bi bi-bookmark-check me-1"></i>Return
                                        </label>
                                    </div>
                                </div>

                                <!-- Bulk Actions -->
                                <div id="bulkActions" class="d-none">
                                    <label class="form-label fw-bold">Bulk Action:</label>
                                    <div class="btn-group w-100" role="group" aria-label="Bulk action selection">
                                        <input type="radio" class="btn-check" name="bulk_action" id="bulk_inventory" value="inventory" checked>
                                        <label class="btn btn-outline-info" for="bulk_inventory">
                                            <i class="bi bi-clipboard-check me-1"></i>Inventory Check
                                        </label>

                                        <input type="radio" class="btn-check" name="bulk_action" id="bulk_return" value="bulk_return">
                                        <label class="btn btn-outline-warning" for="bulk_return">
                                            <i class="bi bi-arrow-return-left me-1"></i>Bulk Return
                                        </label>
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-success btn-sm" id="processBulkBtn" disabled>
                                            <i class="bi bi-play-circle me-1"></i>Process Bulk Scan (<span id="bulkCount">0</span>)
                                        </button>
                                        <button class="btn btn-secondary btn-sm ms-2" id="clearBulkBtn">
                                            <i class="bi bi-trash me-1"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Barcode Input -->
                            <div class="mb-4">
                                <label for="barcodeInput" class="form-label fw-bold">Barcode / ISBN:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-lg" id="barcodeInput"
                                           placeholder="Scan barcode or enter ISBN..." autocomplete="off">
                                    <button class="btn btn-primary" type="button" id="scanBtn">
                                        <i class="bi bi-upc-scan me-1"></i>Scan
                                    </button>
                                </div>
                                <small class="text-muted">Use your barcode scanner or type the code manually</small>
                            </div>

                            <!-- Camera/Scanner Options -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="bi bi-camera me-1"></i>Camera Scanning</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <button class="btn btn-primary mb-2" id="startCameraBtn">
                                                <i class="bi bi-camera-video me-1"></i>Start Camera
                                            </button>
                                            <div id="cameraContainer" class="d-none position-relative">
                                                <video id="camera" class="img-fluid border rounded w-100" autoplay playsinline muted style="max-height: 400px; object-fit: cover;"></video>
                                                <canvas id="canvas" class="d-none"></canvas>
                                                <div id="scanFeedback" class="scan-feedback d-none">
                                                    <i class="bi bi-bullseye me-1"></i>Point camera at barcode
                                                </div>
                                                <div class="mt-2 d-flex justify-content-center gap-2 flex-wrap">
                                                    <button class="btn btn-secondary btn-sm" id="stopCameraBtn">
                                                        <i class="bi bi-stop-circle me-1"></i>Stop Camera
                                                    </button>
                                                    <button class="btn btn-info btn-sm" id="toggleTorchBtn" style="display: none;">
                                                        <i class="bi bi-lightbulb me-1"></i>Toggle Light
                                                    </button>
                                                </div>
                                            </div>
                                            <small class="text-muted d-block mt-2">
                                                Use device camera to scan barcodes
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0"><i class="bi bi-usb me-1"></i>Device Scanner</h6>
                                        </div>
                                        <div class="card-body text-center">
                                            <div class="alert alert-success">
                                                <i class="bi bi-check-circle me-1"></i>
                                                <strong>Ready:</strong> Connect your barcode scanner device
                                            </div>
                                            <small class="text-muted">
                                                Most USB barcode scanners work automatically.<br>
                                                Simply scan and the code will appear in the input field above.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="col-md-4">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-check-circle me-1"></i>Results</h5>
                        </div>
                        <div class="card-body">
                            <div id="results" class="text-center">
                                <i class="bi bi-upc-scan text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3">Scan a barcode to see results here</p>
                            </div>

                            <!-- Scan History -->
                            <div class="mt-3 pt-3 border-top">
                                <h6 class="text-muted mb-2"><i class="bi bi-clock-history me-1"></i>Recent Scans</h6>
                                <div id="scanHistory" class="small">
                                    <small class="text-muted">No recent scans</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card shadow mt-3">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-lightning me-1"></i>Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="{% url 'borrow_records' %}" class="btn btn-outline-primary">
                                    <i class="bi bi-journal-text me-1"></i>View Borrow Records
                                </a>
                                <a href="{% url 'book_list' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-books me-1"></i>Browse Books
                                </a>
                                <a href="{% url 'generate_report' %}?type=books" class="btn btn-outline-success">
                                    <i class="bi bi-file-earmark-spreadsheet me-1"></i>Books Report
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const barcodeInput = document.getElementById('barcodeInput');
    const scanBtn = document.getElementById('scanBtn');
    const resultsDiv = document.getElementById('results');
    const actionRadios = document.querySelectorAll('input[name="action"]');
    let quaggaInitialized = false;
    let scanHistory = [];
    let bulkScanMode = false;
    let bulkScannedItems = [];

    // Function to perform scan
    function performScan(barcode = null) {
        const barcodeValue = barcode || barcodeInput.value.trim();
        if (!barcodeValue) {
            showResult('error', 'Please enter a barcode or ISBN');
            return;
        }

        const action = document.querySelector('input[name="action"]:checked').value;

        // Add to scan history
        addToScanHistory(barcodeValue, action);

        // Show loading
        showResult('loading', 'Searching...');

        // Send AJAX request
        fetch('{% url "scan_barcode" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `barcode=${encodeURIComponent(barcodeValue)}&action=${action}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.action === 'search') {
                    showBookResult(data.book);
                } else {
                    showActionResult(data);
                }
                // Clear input after successful scan
                if (barcode) {
                    barcodeInput.value = '';
                }
            } else {
                showResult('error', data.message);
            }
        })
        .catch(error => {
            showResult('error', 'Network error. Please try again.');
        });
    }

    // Add scan to history
    function addToScanHistory(barcode, action) {
        const timestamp = new Date().toLocaleTimeString();
        scanHistory.unshift({
            barcode: barcode,
            action: action,
            timestamp: timestamp
        });
        // Keep only last 10 scans
        if (scanHistory.length > 10) {
            scanHistory = scanHistory.slice(0, 10);
        }
        updateScanHistoryDisplay();
    }

    // Update scan history display
    function updateScanHistoryDisplay() {
        const historyContainer = document.getElementById('scanHistory');
        if (historyContainer) {
            historyContainer.innerHTML = scanHistory.map(item =>
                `<small class="text-muted d-block">${item.timestamp}: ${item.barcode} (${item.action})</small>`
            ).join('');
        }
    }

    // Bulk scanning functions
    function performBulkScan(barcode = null) {
        const barcodeValue = barcode || barcodeInput.value.trim();
        if (!barcodeValue) {
            showResult('error', 'Please enter a barcode or ISBN');
            return;
        }

        // Check if already scanned
        if (bulkScannedItems.some(item => item.barcode === barcodeValue)) {
            showResult('error', 'This item has already been scanned in bulk mode');
            barcodeInput.value = '';
            return;
        }

        // Add to bulk items
        bulkScannedItems.push({
            barcode: barcodeValue,
            timestamp: new Date().toLocaleTimeString(),
            status: 'pending'
        });

        updateBulkDisplay();
        showResult('success', `Item scanned: ${barcodeValue}. Total: ${bulkScannedItems.length}`);
        barcodeInput.value = '';

        // Add to scan history
        addToScanHistory(barcodeValue, 'bulk_scan');
    }

    function updateBulkDisplay() {
        const bulkCount = document.getElementById('bulkCount');
        const processBtn = document.getElementById('processBulkBtn');

        bulkCount.textContent = bulkScannedItems.length;
        processBtn.disabled = bulkScannedItems.length === 0;

        // Update results display with bulk items
        if (bulkScanMode && bulkScannedItems.length > 0) {
            const html = `
                <div class="text-start">
                    <h6 class="fw-bold">Bulk Scan Items (${bulkScannedItems.length})</h6>
                    <div class="small" style="max-height: 200px; overflow-y: auto;">
                        ${bulkScannedItems.map((item, index) =>
                            `<div class="bulk-item d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <strong>${index + 1}.</strong> ${item.barcode}
                                </div>
                                <small class="text-muted ms-2">${item.timestamp}</small>
                            </div>`
                        ).join('')}
                    </div>
                </div>
            `;
            resultsDiv.innerHTML = html;
        }
    }

    function processBulkScan() {
        const bulkAction = document.querySelector('input[name="bulk_action"]:checked').value;

        showResult('loading', `Processing ${bulkScannedItems.length} items...`);

        // Send bulk request
        fetch('{% url "bulk_scan" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                action: bulkAction,
                items: bulkScannedItems.map(item => item.barcode)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showBulkResults(data);
                bulkScannedItems = [];
                updateBulkDisplay();
            } else {
                showResult('error', data.message);
            }
        })
        .catch(error => {
            showResult('error', 'Network error during bulk processing');
        });
    }

    function showBulkResults(data) {
        let html = `<div class="text-start"><h6 class="fw-bold">Bulk Operation Results</h6>`;

        if (data.results && data.results.length > 0) {
            html += '<div class="small mt-2">';
            data.results.forEach(result => {
                const statusClass = result.success ? 'text-success' : 'text-danger';
                const icon = result.success ? 'bi-check-circle' : 'bi-x-circle';
                html += `<div class="${statusClass}"><i class="bi ${icon} me-1"></i>${result.barcode}: ${result.message}</div>`;
            });
            html += '</div>';
        }

        if (data.summary) {
            html += `<div class="mt-2 pt-2 border-top"><strong>Summary:</strong> ${data.summary}</div>`;
        }

        html += '</div>';
        resultsDiv.innerHTML = html;
    }

    // Mode switching
    document.querySelectorAll('input[name="scan_mode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            bulkScanMode = this.value === 'bulk';
            document.getElementById('singleActions').classList.toggle('d-none', bulkScanMode);
            document.getElementById('bulkActions').classList.toggle('d-none', !bulkScanMode);
            bulkScannedItems = [];
            updateBulkDisplay();
            if (bulkScanMode) {
                showResult('info', 'Bulk scan mode active - scan multiple items');
            } else {
                showResult('info', 'Single scan mode active');
            }
        });
    });

    // Bulk action buttons
    document.getElementById('processBulkBtn').addEventListener('click', processBulkScan);
    document.getElementById('clearBulkBtn').addEventListener('click', function() {
        bulkScannedItems = [];
        updateBulkDisplay();
        showResult('info', 'Bulk scan cleared');
    });

    // Event listeners
    scanBtn.addEventListener('click', function() {
        if (bulkScanMode) {
            performBulkScan();
        } else {
            performScan();
        }
    });

    barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            if (bulkScanMode) {
                performBulkScan();
            } else {
                performScan();
            }
        }
    });

    // Result display functions
    function showResult(type, message) {
        let html = '';
        if (type === 'loading') {
            html = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">${message}</p>
            `;
        } else if (type === 'error') {
            html = `
                <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                <p class="text-danger mt-3">${message}</p>
            `;
        } else if (type === 'info') {
            html = `
                <i class="bi bi-info-circle text-info" style="font-size: 3rem;"></i>
                <p class="text-info mt-3">${message}</p>
            `;
        } else if (type === 'success') {
            html = `
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <p class="text-success mt-3">${message}</p>
            `;
        }
        resultsDiv.innerHTML = html;
    }

    function showBookResult(book) {
        let statusBadge = '';
        if (book.status === 'Available') {
            statusBadge = '<span class="badge bg-success">Available</span>';
        } else if (book.status === 'Borrowed') {
            statusBadge = '<span class="badge bg-warning">Borrowed</span>';
        } else {
            statusBadge = `<span class="badge bg-secondary">${book.status}</span>`;
        }

        const html = `
            <div class="text-start">
                <h6 class="fw-bold">${book.title}</h6>
                <p class="text-muted mb-1">by ${book.author_names}</p>
                <p class="text-muted small mb-2">ISBN: ${book.isbn}</p>
                <div class="mb-2">
                    ${statusBadge}
                    <span class="badge bg-info ms-1">${book.available_copies} copies available</span>
                </div>
                <a href="/books/${book.id}/" class="btn btn-primary btn-sm">
                    <i class="bi bi-eye me-1"></i>View Details
                </a>
            </div>
        `;
        resultsDiv.innerHTML = html;
    }

    function showActionResult(data) {
        let icon = '';
        let color = '';

        if (data.action === 'borrow') {
            icon = 'bi-bookmark-plus';
            color = 'success';
        } else if (data.action === 'return') {
            icon = 'bi-bookmark-check';
            color = 'warning';
        }

        let fineInfo = '';
        if (data.fine && data.fine > 0) {
            fineInfo = `<div class="alert alert-warning mt-2 py-1"><small>Fine: $${data.fine.toFixed(2)}</small></div>`;
        }

        const html = `
            <div class="text-center">
                <i class="bi ${icon} text-${color}" style="font-size: 3rem;"></i>
                <p class="mt-3 fw-bold text-${color}">${data.message}</p>
                ${fineInfo}
                <div class="mt-2">
                    <small class="text-muted">${data.book.available_copies} copies now available</small>
                </div>
            </div>
        `;
        resultsDiv.innerHTML = html;

        // Clear input after successful action
        barcodeInput.value = '';
    }

    // Camera functionality with QuaggaJS
    document.getElementById('startCameraBtn').addEventListener('click', function() {
        startQuaggaScanner();
    });

    document.getElementById('stopCameraBtn').addEventListener('click', function() {
        stopQuaggaScanner();
    });

    let stream = null;
    let torchSupported = false;
    let torchEnabled = false;

    function startQuaggaScanner() {
        const cameraContainer = document.getElementById('cameraContainer');
        const startBtn = document.getElementById('startCameraBtn');
        const scanFeedback = document.getElementById('scanFeedback');

        // Initialize Quagga
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#camera'),
                constraints: {
                    facingMode: "environment", // Use back camera
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            numOfWorkers: navigator.hardwareConcurrency || 2,
            decoder: {
                readers: [
                    "code_128_reader",
                    "ean_reader",
                    "ean_8_reader",
                    "code_39_reader",
                    "code_39_vin_reader",
                    "codabar_reader",
                    "upc_reader",
                    "upc_e_reader",
                    "i2of5_reader",
                    "2of5_reader",
                    "code_93_reader",
                    "qr_code_reader"
                ]
            },
            locate: true
        }, function(err) {
            if (err) {
                console.error('Quagga initialization failed:', err);
                alert('Failed to initialize camera scanner. Please try manual entry.');
                return;
            }

            console.log('Quagga initialized successfully');
            quaggaInitialized = true;
            cameraContainer.classList.remove('d-none');
            startBtn.classList.add('d-none');
            scanFeedback.classList.remove('d-none');

            // Get the stream for torch control
            stream = Quagga.canvas.ctx.image.getImageData(0, 0, 1, 1); // This is a workaround to get stream access

            // Check for torch support
            checkTorchSupport();

            // Start scanning
            Quagga.start();

            // Show scanning feedback
            const modeText = bulkScanMode ? 'Bulk scan active' : 'Camera active';
            showResult('info', `${modeText} - point at barcode to scan`);
        });

        // Listen for detected barcodes
        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            console.log('Barcode detected:', code);

            // Stop scanning temporarily
            Quagga.stop();

            // Process based on mode
            if (bulkScanMode) {
                performBulkScan(code);
            } else {
                barcodeInput.value = code;
                performScan(code);
            }

            // Restart scanning after a delay
            setTimeout(() => {
                if (quaggaInitialized) {
                    Quagga.start();
                    const modeText = bulkScanMode ? 'Bulk scan active' : 'Camera active';
                    showResult('info', `${modeText} - point at barcode to scan`);
                }
            }, bulkScanMode ? 1000 : 2000); // Faster restart for bulk mode
        });

        Quagga.onProcessed(function(result) {
            // Add visual feedback for scanning
            const drawingCtx = Quagga.canvas.ctx.overlay;
            const drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                }

                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                }
            }
        });
    }

    function stopQuaggaScanner() {
        if (torchEnabled) {
            toggleTorch();
        }

        if (quaggaInitialized) {
            Quagga.stop();
            quaggaInitialized = false;
        }

        document.getElementById('cameraContainer').classList.add('d-none');
        document.getElementById('scanFeedback').classList.add('d-none');
        document.getElementById('startCameraBtn').classList.remove('d-none');
        document.getElementById('toggleTorchBtn').style.display = 'none';
        showResult('info', 'Camera scanner stopped');
    }

    function checkTorchSupport() {
        if ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(mediaStream) {
                    const track = mediaStream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    torchSupported = capabilities.torch || false;
                    if (torchSupported) {
                        document.getElementById('toggleTorchBtn').style.display = 'inline-block';
                    }
                    track.stop();
                })
                .catch(function(err) {
                    console.log('Torch support check failed:', err);
                });
        }
    }

    function toggleTorch() {
        if (!torchSupported || !stream) return;

        const track = stream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();

        if (capabilities.torch) {
            track.applyConstraints({
                advanced: [{ torch: !torchEnabled }]
            }).then(() => {
                torchEnabled = !torchEnabled;
                const torchBtn = document.getElementById('toggleTorchBtn');
                torchBtn.innerHTML = torchEnabled ?
                    '<i class="bi bi-lightbulb-fill me-1"></i>Turn Off Light' :
                    '<i class="bi bi-lightbulb me-1"></i>Turn On Light';
                torchBtn.className = torchEnabled ? 'btn btn-warning btn-sm' : 'btn btn-info btn-sm';
            }).catch(err => {
                console.error('Torch toggle failed:', err);
            });
        }
    }

    // Add torch button event listener
    document.getElementById('toggleTorchBtn').addEventListener('click', toggleTorch);

    // Auto-focus on barcode input
    barcodeInput.focus();

    // Listen for barcode scanner input (usually ends with Enter)
    let barcodeBuffer = '';
    let lastKeyTime = Date.now();

    document.addEventListener('keydown', function(e) {
        const currentTime = Date.now();

        // If it's been more than 100ms since last key, clear buffer (new scan)
        if (currentTime - lastKeyTime > 100) {
            barcodeBuffer = '';
        }
        lastKeyTime = currentTime;

        // If Enter is pressed and we have a barcode, process it
        if (e.key === 'Enter' && barcodeBuffer.length > 0) {
            barcodeInput.value = barcodeBuffer;
            performScan();
            barcodeBuffer = '';
            e.preventDefault();
        } else if (e.key.length === 1) { // Only add printable characters
            barcodeBuffer += e.key;
        }
    });
});
</script>
{% endblock %}